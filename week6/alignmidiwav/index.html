
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      -->
      <title>Aligning MIDI scores to music audio</title>
      <meta name="generator" content="MATLAB 7.8">
      <meta name="date" content="2009-07-27">
      <meta name="m-file" content="demo_alignmidiwav"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head>
   <body>
      <a href="http://www.ee.columbia.edu/~dpwe/">Dan Ellis</a> : <a href="http://www.ee.columbia.edu/~dpwe/resources/">Resources</a>: <a href="http://www.ee.columbia.edu/~dpwe/resources/matlab/">Matlab</a>: <div class="content"> <IMG SRC="alignmidiwav.jpg" ALIGN="LEFT" HSPACE="10">
         <h1>Aligning MIDI scores to music audio</h1>
         <!--introduction-->
         <p>To obtain ground-truth transcriptions of real music audio, it is sometimes possible to find a MIDI version of the track which
            can then be aligned in time.  The time-aligned MIDI events can then be taken as an approximate transcription of the audio.
            There are several ways to do this, including several choices of the domain in which to do the matching; one popular approach
            is to synthesize the MIDI version to audio, then do a time alignment between the original audio and the synthetic audio (see,
            e.g., Turetsky and Ellis ISMIR 2003, or Hu, Dannenberg, and Tzanetakis, WASPAA, 2003).
         </p>
         <p>This code takes a slightly simpler approach.  The MIDI file is converted into a "mask", indicating which cells of a spectrogram
            would be expected to contain energy.  This is then aligned to the spectrogram of the actual audio.  This is inspired by the
            "Peak Structure Distance" of Orio and Schwarz, ICMC, 2001.
         </p>
         <!--/introduction-->
         <h2>Contents</h2>
         <div>
            <ul>
               <li><a href="#1">Example usage</a></li>
               <li><a href="#2">Rewriting the MIDI file</a></li>
               <li><a href="#3">Download</a></li>
               <li><a href="#4">Referencing</a></li>
               <li><a href="#5">Acknowledgment</a></li>
            </ul>
         </div>
         <h2>Example usage<a name="1"></a></h2>
         <p>The code below shows how to run the alignment using the main <a href="alignmidiwav.m">alignmidiwav</a> routine, and a couple of ways of how the outputs can be used.
         </p><pre class="codeinput"><span class="comment">% We will need the Jyv&auml;skyl&auml; MIDI toolbox</span>
<span class="comment">% from http://www.jyu.fi/musica/miditoolbox/</span>
<span class="keyword">if</span> exist(<span class="string">'readmidi'</span>) ~= 2; <span class="keyword">...</span>
      addpath([<span class="string">'/Users/drspeech/share/lib/matlab/miditoolbox'</span>]); <span class="keyword">end</span>
<span class="comment">% Main function takes MIDI file and audio file as input</span>
<span class="comment">% .1 is the time resolution (100ms).  The 4th argument selects</span>
<span class="comment">% cosine-distance matching (0), or "peak structure distance" (1).</span>
tres = 0.1;
midifile = <span class="string">'SoS.mid'</span>;
wavfile = <span class="string">'06_Sultans_of_Swing.mp3'</span>;
[m,p,q,S,D,M] = alignmidiwav(midifile,wavfile,tres,0);
<span class="comment">% D returns the (sub-1kHz) spectrogram derived from the wav file,</span>
<span class="comment">% and M returns the spectrogram-like mask derived from the MIDI.</span>
<span class="comment">% m is a mapping index s.t. M(:,m) aligns to D(:,:)</span>
subplot(211)
<span class="comment">% avoid log(0) - replace with smallest nonzero value</span>
D(D(:)==0) = min(D(D(:)&gt;0));
<span class="comment">% plot spectrogram</span>
imagesc(20*log10(D));
axis <span class="string">xy</span>;
caxis(max(caxis)+[-50 0])
colormap(1-gray)
<span class="comment">% outline() takes a binary matrix and superimposes outlines on an</span>
<span class="comment">% existing image</span>
outline(M(:,m),0,<span class="string">'r'</span>)
<span class="comment">% We probably want to zoom in to see the detail</span>
maxcol = min(1000,min(size(M,2),size(D,2)));
axis([0 maxcol 0 size(D,1)])
<span class="comment">% Also plot the DP cost matrix, and the path on top (for the start)</span>
subplot(212)
imagesc(S(1:maxcol, 1:maxcol)); axis <span class="string">xy</span>;
hold <span class="string">on</span>; plot(q,p,<span class="string">'-r'</span>); hold <span class="string">off</span>
</pre><img vspace="5" hspace="5" src="demo_alignmidiwav_01.png" alt=""> <h2>Rewriting the MIDI file<a name="2"></a></h2>
         <p>We can rewrite a MIDI file that ought to synchronize with the audio.  To do this, we take the original MIDI file, map all
            its times according to the mapping that resulted from the DP match within <a href="alignmidiwav.m">alignmidiwav</a>.  For fun (and manual validation), we can even resynthesize that midi file, and make a stereo file with the original audio
            in one side, and the midi resynthesis in the other.
         </p><pre class="codeinput"><span class="comment">% Read in the original MIDI file (using the Jyv&auml;skyl&auml; toolbox)</span>
nmat = readmidi(midifile);
<span class="comment">% Map the times using the p (MIDI ref times) and q (audio times)</span>
<span class="comment">% index returns from the alignment.  They are in units of the time</span>
<span class="comment">% resolution (i.e. indices into the similarity matrix).</span>
<span class="comment">% We rewrite the beat-times, but start from the original times-in-seconds.</span>
<span class="comment">% First, convert durations to end times</span>
nmat(:,7) = nmat(:,6) + nmat(:,7);
<span class="comment">% Do the mapping based on alignment returns</span>
nmat(:,1:2) = maptimes(nmat(:,6:7),(p-1)*tres,(q-1)*tres);
<span class="comment">% Convert end-times back to durations</span>
nmat(:,2) = nmat(:,2) - nmat(:,1);
<span class="comment">% Write it out.  We remove channel 10 since it's the drums</span>
<span class="comment">% (but all instruments are mapped to piano in writemidi)</span>
<span class="comment">% Last argument, 60 bpm, ensures that time in beats becomes time in secs.</span>
writemidi(nmat(nmat(:,3)~=10,:),<span class="string">'tmp.mid'</span>,120,60,4,4);

<span class="comment">% If you externally convert tmp.mid to tmp.mp3 using a MIDI</span>
<span class="comment">% synthesizer, you can then generate a stereo file from the</span>
<span class="comment">% original audio and the MIDI resynthesis to check they make</span>
<span class="comment">% sense.</span>
<span class="comment">% midi2wav.scpt is an AppleScript (MacOSX) that does this via</span>
<span class="comment">% iTunes (but needs a full path as input)</span>
system([<span class="string">'rm -f tmp.mp3'</span>]);
system([<span class="string">'osascript midi2mp3.scpt '</span>,pwd(),<span class="string">'/tmp.mid'</span>]);
<span class="comment">% Now read in both audio files and merge them as L and R channels</span>
[do,sro] = mp3read(wavfile);
[dm,srm] = mp3read(<span class="string">'tmp.mp3'</span>,0,1,2);
<span class="comment">% convert to mono</span>
<span class="keyword">if</span> size(do,2) == 2; do = mean(do')'; <span class="keyword">end</span>
<span class="keyword">if</span> size(dm,2) == 2; dm = mean(dm')'; <span class="keyword">end</span>
<span class="comment">% sample rates must match!</span>
<span class="keyword">if</span> sro ~= srm;
  dm = 0.9*resample(dm,sro,srm);
<span class="keyword">end</span>
<span class="comment">% make the same length</span>
maxl = max(length(do),length(dm));
do(maxl) = 0;
dm(maxl) = 0;
<span class="comment">% write out</span>
mp3write([do,dm],sro,<span class="string">'stereo.mp3'</span>);
</pre><h2>Download<a name="3"></a></h2>
         <p>You can download all the code and data for these examples here: <a href="alignmidiwav.tgz">alignmidiwav.tgz</a>. You will also need the dynamic programming code (dpfast.m) from <a href="http://labrosa.ee.columbia.edu/matlab/dtw/">http://labrosa.ee.columbia.edu/matlab/dtw/</a> . You will also need the <a href="http://www.jyu.fi/hum/laitokset/musiikki/en/research/coe/materials/miditoolbox/">Jyv&auml;skyl&auml; MIDI toolbox</a>.
         </p>
         <p>And for the demo code above, you will need <a href="http://www.ee.columbia.edu/~dpwe/resources/matlab/mp3read.html">mp3 read/write</a>.
         </p>
         <h2>Referencing<a name="4"></a></h2>
         <p>If you use this work in a publication, I would be grateful if you referenced this page as follows:</p>
         <p>D. P. W. Ellis (2008).  "Aligning MIDI scores to music audio", web resource. <a href="http://www.ee.columbia.edu/~dpwe/resources/matlab/alignmidiwav/">http://www.ee.columbia.edu/~dpwe/resources/matlab/alignmidiwav/</a></p>
         <h2>Acknowledgment<a name="5"></a></h2>
         <p>This project was supported in part by the NSF under grant IIS-0713334. Any opinions, findings and conclusions or recommendations
            expressed in this material are those of the authors and do not necessarily reflect the views of the Sponsors.
         </p><pre class="codeinput"><span class="comment">% Last updated: $Date: 2009/07/07 14:14:11 $</span>
<span class="comment">% Dan Ellis &lt;dpwe@ee.columbia.edu&gt;</span>
</pre><p class="footer"><br>
            Published with MATLAB&reg; 7.8<br></p>
      </div>
      <!--
##### SOURCE BEGIN #####
%% Aligning MIDI scores to music audio
%
% To obtain ground-truth transcriptions of real music audio, it is 
% sometimes possible to find a MIDI version of the track which can 
% then be aligned in time.  The time-aligned MIDI events can then 
% be taken as an approximate transcription of the audio.  There are 
% several ways to do this, including several choices of the domain 
% in which to do the matching; one popular approach is to
% synthesize the MIDI version to audio, then do a time alignment
% between the original audio and the synthetic audio (see, e.g.,
% Turetsky and Ellis ISMIR 2003, or Hu, Dannenberg, and Tzanetakis,
% WASPAA, 2003). 
%
% This code takes a slightly simpler approach.  The MIDI file is
% converted into a "mask", indicating which cells of a spectrogram
% would be expected to contain energy.  This is then aligned to
% the spectrogram of the actual audio.  This is inspired by the 
% "Peak Structure Distance" of Orio and Schwarz, ICMC, 2001.

%% Example usage
% The code below shows how to run the alignment using the main
% <alignmidiwav.m alignmidiwav> routine, and a couple of ways of
% how the outputs can be used. 

% We will need the Jyv채skyl채 MIDI toolbox 
% from http://www.jyu.fi/musica/miditoolbox/ 
if exist('readmidi') ~= 2; ...
      addpath(['/Users/drspeech/share/lib/matlab/miditoolbox']); end
% Main function takes MIDI file and audio file as input
% .1 is the time resolution (100ms).  The 4th argument selects 
% cosine-distance matching (0), or "peak structure distance" (1).
tres = 0.1;
midifile = 'SoS.mid';
wavfile = '06_Sultans_of_Swing.mp3';
[m,p,q,S,D,M] = alignmidiwav(midifile,wavfile,tres,0);
% D returns the (sub-1kHz) spectrogram derived from the wav file, 
% and M returns the spectrogram-like mask derived from the MIDI.
% m is a mapping index s.t. M(:,m) aligns to D(:,:)
subplot(211)
% avoid log(0) - replace with smallest nonzero value
D(D(:)==0) = min(D(D(:)>0));
% plot spectrogram
imagesc(20*log10(D));
axis xy;
caxis(max(caxis)+[-50 0])
colormap(1-gray)
% outline() takes a binary matrix and superimposes outlines on an
% existing image
outline(M(:,m),0,'r')
% We probably want to zoom in to see the detail
maxcol = min(1000,min(size(M,2),size(D,2)));
axis([0 maxcol 0 size(D,1)])
% Also plot the DP cost matrix, and the path on top (for the start)
subplot(212)
imagesc(S(1:maxcol, 1:maxcol)); axis xy;
hold on; plot(q,p,'-r'); hold off


%% Rewriting the MIDI file
% We can rewrite a MIDI file that ought to synchronize with the
% audio.  To do this, we take the original MIDI file, map all 
% its times according to the mapping that resulted from the DP 
% match within <alignmidiwav.m alignmidiwav>.  For fun (and manual 
% validation), we can even resynthesize that midi file, and make a
% stereo file with the original audio in one side, and the midi
% resynthesis in the other.

% Read in the original MIDI file (using the Jyv채skyl채 toolbox)
nmat = readmidi(midifile);
% Map the times using the p (MIDI ref times) and q (audio times)
% index returns from the alignment.  They are in units of the time
% resolution (i.e. indices into the similarity matrix).
% We rewrite the beat-times, but start from the original times-in-seconds.
% First, convert durations to end times
nmat(:,7) = nmat(:,6) + nmat(:,7);
% Do the mapping based on alignment returns
nmat(:,1:2) = maptimes(nmat(:,6:7),(p-1)*tres,(q-1)*tres);
% Convert end-times back to durations
nmat(:,2) = nmat(:,2) - nmat(:,1);
% Write it out.  We remove channel 10 since it's the drums
% (but all instruments are mapped to piano in writemidi)
% Last argument, 60 bpm, ensures that time in beats becomes time in secs.
writemidi(nmat(nmat(:,3)~=10,:),'tmp.mid',120,60,4,4);

% If you externally convert tmp.mid to tmp.mp3 using a MIDI
% synthesizer, you can then generate a stereo file from the
% original audio and the MIDI resynthesis to check they make
% sense. 
% midi2wav.scpt is an AppleScript (MacOSX) that does this via
% iTunes (but needs a full path as input)
system(['rm -f tmp.mp3']);
system(['osascript midi2mp3.scpt ',pwd(),'/tmp.mid']);
% Now read in both audio files and merge them as L and R channels
[do,sro] = mp3read(wavfile);
[dm,srm] = mp3read('tmp.mp3',0,1,2);
% convert to mono
if size(do,2) == 2; do = mean(do')'; end
if size(dm,2) == 2; dm = mean(dm')'; end
% sample rates must match!
if sro ~= srm; 
  dm = 0.9*resample(dm,sro,srm);
end
% make the same length
maxl = max(length(do),length(dm));
do(maxl) = 0;
dm(maxl) = 0;
% write out
mp3write([do,dm],sro,'stereo.mp3');


%% Download
% You can download all the code and data for these examples here:
% <alignmidiwav.tgz alignmidiwav.tgz>.
% You will also need the dynamic programming code (dpfast.m) from 
% http://labrosa.ee.columbia.edu/matlab/dtw/ .
% You will also need the 
% <http://www.jyu.fi/hum/laitokset/musiikki/en/research/coe/materials/miditoolbox/ Jyv&auml;skyl&auml; MIDI toolbox>.
%
% And for the demo code above, you will need
% <http://www.ee.columbia.edu/~dpwe/resources/matlab/mp3read.html mp3 read/write>.
%

%% Referencing
% If you use this work in a publication, I would be grateful 
% if you referenced this page as follows:
%
% D. P. W. Ellis (2008).  "Aligning MIDI scores to music audio", web resource.
% http://www.ee.columbia.edu/~dpwe/resources/matlab/alignmidiwav/

%% Acknowledgment
% This project was supported in part by the NSF under 
% grant IIS-0713334. Any opinions, findings and conclusions 
% or recommendations expressed in this material are those of the 
% authors and do not necessarily reflect the views of the Sponsors.

% Last updated: $Date: 2009/07/07 14:14:11 $
% Dan Ellis <dpwe@ee.columbia.edu>

##### SOURCE END #####
-->
   </body>
</html>
